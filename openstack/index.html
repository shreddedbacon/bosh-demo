



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Deploy into Openstack - BOSH Demo</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#reference_information" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="BOSH Demo" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                BOSH Demo
              </span>
              <span class="md-header-nav__topic">
                Deploy into Openstack
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="BOSH Demo" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    BOSH Demo
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../director/" title="Build BOSH Director" class="md-nav__link">
      Build BOSH Director
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../release/" title="Create BOSH Release" class="md-nav__link">
      Create BOSH Release
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../deploy/" title="Deploy into VirtualBox" class="md-nav__link">
      Deploy into VirtualBox
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Deploy into Openstack
      </label>
    
    <a href="./" title="Deploy into Openstack" class="md-nav__link md-nav__link--active">
      Deploy into Openstack
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reference_information" title="Reference Information" class="md-nav__link">
    Reference Information
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loadbalancer" title="LoadBalancer" class="md-nav__link">
    LoadBalancer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh_tunnels" title="SSH Tunnels" class="md-nav__link">
    SSH Tunnels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access" title="Access" class="md-nav__link">
    Access
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web" title="Web" class="md-nav__link">
    Web
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jumpbox" title="Jumpbox" class="md-nav__link">
    Jumpbox
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" title="Resources" class="md-nav__link">
    Resources
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deployment_manifest" title="Deployment Manifest" class="md-nav__link">
    Deployment Manifest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations_files" title="Operations Files" class="md-nav__link">
    Operations Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud_configuration" title="Cloud Configuration" class="md-nav__link">
    Cloud Configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying" title="Deploying" class="md-nav__link">
    Deploying
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../turbulence/" title="Chaos Engineering" class="md-nav__link">
      Chaos Engineering
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#reference_information" title="Reference Information" class="md-nav__link">
    Reference Information
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#loadbalancer" title="LoadBalancer" class="md-nav__link">
    LoadBalancer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssh_tunnels" title="SSH Tunnels" class="md-nav__link">
    SSH Tunnels
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#access" title="Access" class="md-nav__link">
    Access
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#web" title="Web" class="md-nav__link">
    Web
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jumpbox" title="Jumpbox" class="md-nav__link">
    Jumpbox
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" title="Resources" class="md-nav__link">
    Resources
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deployment_manifest" title="Deployment Manifest" class="md-nav__link">
    Deployment Manifest
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#operations_files" title="Operations Files" class="md-nav__link">
    Operations Files
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cloud_configuration" title="Cloud Configuration" class="md-nav__link">
    Cloud Configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploying" title="Deploying" class="md-nav__link">
    Deploying
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  <h1>Deploy into Openstack</h1>
                
                <p>Most of what is here is only used for this demo, some key places to look at are the following if you want to find out main differences.</p>
<ul>
<li>Deployment Manifest</li>
<li>Operations Files</li>
<li>Cloud Configuration</li>
</ul>
<h2 id="reference_information">Reference Information<a class="headerlink" href="#reference_information" title="Permanent link">#</a></h2>
<p>This section is for the demo only</p>
<h3 id="loadbalancer">LoadBalancer<a class="headerlink" href="#loadbalancer" title="Permanent link">#</a></h3>
<ul>
<li>192.168.101.69</li>
</ul>
<h3 id="ssh_tunnels">SSH Tunnels<a class="headerlink" href="#ssh_tunnels" title="Permanent link">#</a></h3>
<p>A lot of the networking in this section is specific to the demo performed at the Infracoders meetup, be aware it probably won't work elsewhere.</p>
<div class="codehilite"><pre><span></span>ssh -nNt -L 2222:192.168.101.91:22 10.8.0.10 #jumpbox
ssh -nNt -L 7000:192.168.101.30:80 10.8.0.10 #openstack dashboard
ssh -nNt -L 7001:192.168.101.69:80 10.8.0.10 #openstack loadbalancer
ssh -nNt -p 2222 -L 7002:192.168.209.7:8080 ubuntu@localhost #jumpbox-&gt;director-&gt;turbulence
</pre></div>


<h3 id="access">Access<a class="headerlink" href="#access" title="Permanent link">#</a></h3>
<h4 id="web">Web<a class="headerlink" href="#web" title="Permanent link">#</a></h4>
<ul>
<li><a href="http://localhost:7000/dashboard/project/instances/">Openstack Dashboard</a></li>
<li><a href="http://localhost:7000/dashboard/project/ngloadbalancersv2/0a839cc2-abb1-4801-9eb3-caa616374628/listeners/6eea0e96-419a-431f-adf2-8061d366ca54/pools/246dce06-1504-41d2-8805-f1a2ae1e8337">Openstack Load Balancer Pool</a></li>
<li><a href="http://localhost:7001">Load Balancer</a></li>
<li><a href="https://localhost:7002/">Turbulence Dashboard</a></li>
</ul>
<h4 id="jumpbox">Jumpbox<a class="headerlink" href="#jumpbox" title="Permanent link">#</a></h4>
<div class="codehilite"><pre><span></span>scp -p 2222 /tmp/static-site.tgz ubuntu@localhost:/tmp/static-site.tgz
ssh -p ubuntu@localhost
</pre></div>


<h2 id="resources">Resources<a class="headerlink" href="#resources" title="Permanent link">#</a></h2>
<h3 id="deployment_manifest">Deployment Manifest<a class="headerlink" href="#deployment_manifest" title="Permanent link">#</a></h3>
<p>Create the deployment manifest on the jumpbox, this is exactly the same manifest as used in virtualbox</p>
<div class="codehilite"><pre><span></span>cd
mkdir demo
cat &lt;&lt; &quot;EOF&quot; &gt; demo/deployment.yml
---
name: static-web

releases:
- name: staticsite-boshrelease
  version: latest
- name: nginx
  version: latest

stemcells:
- alias: default
  os: ubuntu-xenial
  version: latest

instance_groups:
- name: webserver
  instances: 1
  stemcell: default
  vm_type: default
  azs: [z1]
  persistent_disk_type: default
  networks:
  - name: default
  jobs:
  - name: staticsite
    release: staticsite-boshrelease
    properties:
      docroot: ((staticsite_docroot))
  - name: nginx
    release: nginx
    properties:
      nginx_worker_processes: auto
      nginx_worker_connections: 1024
      nginx_servers:
      - server_name: ((staticsite_domain))
        docroot: ((staticsite_docroot))
        port: ((staticsite_http_port))
        index: &quot;index.html&quot;
        access_log: /var/vcap/sys/log/nginx/access.log
        error_log: /var/vcap/sys/log/nginx/error.log
        custom_data: ((nginx_config))

update:
  canaries: 1
  max_in_flight: 1
  serial: false
  canary_watch_time: 1000-60000
  update_watch_time: 1000-60000
EOF
</pre></div>


<p>We are also going to use some variables to set up the docroot and listening domain and port for nginx too these are defined in the deployment manifest using <code>((variable_name))</code></p>
<div class="codehilite"><pre><span></span>cat &lt;&lt; &quot;EOF&quot; &gt; demo/variables.yml
staticsite_domain: staticsite.demo
staticsite_docroot: /var/vcap/store/nginx/www/document_root
staticsite_http_port: 80
nginx_config: |
  location / {
    try_files $uri $uri/ =404;
  }
EOF
</pre></div>


<h3 id="operations_files">Operations Files<a class="headerlink" href="#operations_files" title="Permanent link">#</a></h3>
<p>We want to creat some operations that override the behaviour of our original default deployment.</p>
<div class="codehilite"><pre><span></span>cat &lt;&lt; &quot;EOF&quot; &gt; demo/ops-instances.yml
---
- type: replace
  path: /instance_groups/name=webserver/instances
  value: 6
- type: replace
  path: /instance_groups/name=webserver/vm_type
  value: lbmicro
- type: replace
  path: /instance_groups/name=webserver/networks/name=default/name
  value: demonet01
EOF
</pre></div>


<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Our operations are only changing the vm_type and the number of instances we want to deploy, and which network they will live in. The vm_type <code>lbmicro</code> is defined in the Cloud Configuration.</p>
</div>
<h3 id="cloud_configuration">Cloud Configuration<a class="headerlink" href="#cloud_configuration" title="Permanent link">#</a></h3>
<div class="codehilite"><pre><span></span>cat &lt;&lt; &quot;EOF&quot; &gt; demo/cloud-config.yml
---
azs:
- name: z1
  cloud_properties:
    availability_zone: nova

vm_types:
- name: default
  cloud_properties:
    instance_type: m1.micro
- name: tiny
  cloud_properties:
    instance_type: m1.tiny
- name: micro
  cloud_properties:
    instance_type: m1.micro
- name: small
  cloud_properties:
    instance_type: m1.small
- name: medium
  cloud_properties:
    instance_type: m1.medium
- name: large
  cloud_properties:
    instance_type: m1.large
- name: xlarge
  cloud_properties:
    instance_type: m1.xlarge
- name: lbsmall
  cloud_properties:
    instance_type: m1.small
    loadbalancer_pools:
      - name: demo-pool
        port: 80
- name: lbmicro
  cloud_properties:
    instance_type: m1.micro
    loadbalancer_pools:
      - name: demo-pool
        port: 80

disk_types:
- name: default
  disk_size: 1024
  cloud_properties:
    type: nfs
- name: micro
  disk_size: 5_120
  cloud_properties:
    type: nfs
- name: small
  disk_size: 10_240
  cloud_properties:
    type: nfs
- name: medium
  disk_size: 20_480
  cloud_properties:
    type: nfs
- name: large
  disk_size: 30_720
  cloud_properties:
    type: nfs

networks:
- name: default
  type: manual
  subnets:
  - azs: [z1]
    dns: [192.168.101.1]
    range: 192.168.209.0/24
    gateway: 192.168.209.1
    static: [192.168.209.10-192.168.209.99]
    reserved: [192.168.209.2-192.168.209.9,192.168.209.100]
    cloud_properties:
      net_id: 16533825-c891-4e2b-8124-490a0b5bae4e
      security_groups: [demo-bosh, demo-web, demo-all]
- name: demonet01
  type: manual
  subnets:
  - azs: [z1]
    dns: [192.168.101.1]
    range: 192.168.140.0/24
    gateway: 192.168.140.1
    static: [192.168.140.10-192.168.140.99]
    reserved: [192.168.140.2-192.168.140.9,192.168.140.100]
    cloud_properties:
      net_id: ea119a90-86a0-44fc-b86c-3aa6c50dd3e0
      security_groups: [demo-bosh, demo-web]
- name: vip
  type: vip

compilation:
  workers: 4
  az: z1
  reuse_compilation_vms: true
  vm_type: medium
  network: default
EOF
</pre></div>


<div class="admonition info">
<p class="admonition-title">Info</p>
<p>You can see that we have cloud_properties defined for some things in this manifest, where our virtualbox cloud configuration doesn't.
Cloud properties are used to tell the CPI what to use when it builds, or what to attach something to.
In the case of <code>lbmicro</code> we are telling it that the instance_type to use in openstack is an m1.micro, and that once built they need to be assigned to the loadbalancer pool called <code>demo-pool</code>.</p>
<p>Similar things are done for the network definition where it tells the CPI which networks to build in, and which security groups to assign to vms built in those networks.</p>
</div>
<h2 id="deploying">Deploying<a class="headerlink" href="#deploying" title="Permanent link">#</a></h2>
<p>Now we are ready to deploy it into openstack.</p>
<div class="codehilite"><pre><span></span>cd bucc
</pre></div>


<p>Upload our cloud configuration</p>
<div class="codehilite"><pre><span></span>bosh ucc ../demo/cloud-config.yml
</pre></div>


<p>Upload our releases</p>
<div class="codehilite"><pre><span></span>bosh upload-stemcell https://bosh.io/d/stemcells/bosh-openstack-kvm-ubuntu-xenial-go_agent?v=97.17
</pre></div>


<div class="codehilite"><pre><span></span>bosh upload-release https://github.com/shreddedbacon/nginx-boshrelease/releases/download/v1.2.7/nginx-1.2.7.tgz
</pre></div>


<div class="codehilite"><pre><span></span>bosh upload-release /tmp/static-site.tgz
</pre></div>


<p>And finally deploy it</p>
<div class="codehilite"><pre><span></span># no LB
bosh -d static-web d ../demo/deployment.yml -l ../demo/variables.yml
</pre></div>


<div class="codehilite"><pre><span></span># with LB
bosh -d static-web d ../demo/deployment.yml -o ../demo/ops-instances.yml -l ../demo/variables.yml
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../deploy/" title="Deploy into VirtualBox" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Deploy into VirtualBox
              </span>
            </div>
          </a>
        
        
          <a href="../turbulence/" title="Chaos Engineering" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Chaos Engineering
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.583bbe55.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
      
    
  </body>
</html>